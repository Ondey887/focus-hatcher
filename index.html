<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Focus Hatcher</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* === –°–¢–ò–õ–ò === */
        body { background-color: #1c1c1e; color: white; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; overflow-y: auto; user-select: none; -webkit-tap-highlight-color: transparent; transition: background-color 0.5s ease; }
        
        /* –û–¢–õ–ê–î–ö–ê */
        #debug-console { width: 95%; background: rgba(0, 0, 0, 0.8); border: 1px solid #ff3b30; color: #0f0; font-size: 10px; font-family: monospace; padding: 10px; margin-top: 5px; border-radius: 8px; z-index: 9999; word-wrap: break-word; display: none; }
        .error-msg { color: #ff3b30; font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #555; }
        #emergency-reset { background: #ff3b30; color: white; border: none; padding: 10px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; z-index: 10000; font-weight: bold; width: 90%; font-size: 12px;}

        /* UI */
        .container { text-align: center; width: 100%; max-width: 350px; padding: 20px; position: relative; padding-bottom: 80px; }
        .top-bar { position: absolute; top: 10px; left: 10px; right: 10px; z-index: 10; display: flex; justify-content: space-between; }
        .left-buttons { display: flex; gap: 10px; }
        .icon-btn { background: rgba(255,255,255,0.1); border: none; font-size: 20px; padding: 0; border-radius: 50%; cursor: pointer; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .red-dot { position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background-color: #ff3b30; border-radius: 50%; box-shadow: 0 0 5px #ff3b30; }
        
        h1 { font-size: 24px; margin-bottom: 15px; color: #ffd700; margin-top: 40px; }
        .level-container { background: rgba(255, 255, 255, 0.1); padding: 10px 15px; border-radius: 12px; margin-bottom: 20px; text-align: left; }
        .stats-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .money-display { font-size: 16px; font-weight: bold; color: #85bb65; }
        .progress-bar-bg { background: rgba(0, 0, 0, 0.5); height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #34c759, #32d74b); width: 0%; transition: width 0.5s ease-out; }
        
        .slider-container { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }
        .arrow-btn { background: none; border: none; color: rgba(255, 255, 255, 0.4); font-size: 40px; cursor: pointer; padding: 10px; }
        
        #timer { font-size: 56px; font-weight: bold; margin: 15px 0; font-variant-numeric: tabular-nums; }
        .btn { background-color: #007aff; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 12px; width: 100%; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.96); }
        .btn.stop { background-color: #ff3b30; }
        .share-btn { background-color: #34c759; }

        .egg { font-size: 100px; display: inline-block; transition: transform 0.3s; animation: breathe 3s infinite ease-in-out; }
        .egg.diamond-egg { filter: drop-shadow(0 0 15px cyan); transform: rotate(180deg); animation: breathe-diamond 3s infinite ease-in-out !important; }
        @keyframes breathe { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes breathe-diamond { 0% { transform: rotate(180deg) scale(1); } 50% { transform: rotate(180deg) scale(1.05); } 100% { transform: rotate(180deg) scale(1); } }
        .shaking { animation: shake 0.5s infinite !important; }
        .egg.diamond-egg.shaking { animation: shake-inverted 0.5s infinite !important; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        @keyframes shake-inverted { 0% { transform: rotate(180deg); } 25% { transform: rotate(185deg); } 50% { transform: rotate(180deg); } 75% { transform: rotate(175deg); } 100% { transform: rotate(180deg); } }
        .egg.skin-glow { filter: drop-shadow(0 0 15px #fff); }
        .egg.skin-gold { filter: drop-shadow(0 0 10px #ffd700) brightness(1.2); }
        .egg.skin-glitch { animation: shake 0.2s infinite !important; filter: hue-rotate(90deg); }
        .egg.skin-ice { filter: drop-shadow(0 0 10px #00ffff) hue-rotate(180deg); }

        .boosters-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; min-height: 50px; }
        .booster-slot { width: 50px; height: 50px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; position: relative; border: 2px solid transparent; transition: all 0.2s; }
        .booster-slot.active { background: rgba(52, 199, 89, 0.2); border-color: #34c759; box-shadow: 0 0 10px rgba(52, 199, 89, 0.5); transform: scale(1.1); }
        .booster-slot.empty { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        .booster-count { position: absolute; bottom: -5px; right: -5px; background: #007aff; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        .inventory-header { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-top: 20px; cursor: pointer; font-weight: bold; color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .inventory-header:active { background: rgba(255,255,255,0.1); }
        #collection { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 10px; background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 15px; overflow: hidden; }
        #collection.hidden { display: none; }
        .pet-slot { font-size: 28px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 5px; text-align: center; cursor: pointer; position: relative; height: 40px; display: flex; justify-content: center; align-items: center; }
        .pet-slot.common { border: 2px solid #8e8e93; }
        .pet-slot.rare { border: 2px solid #007aff; box-shadow: 0 0 8px rgba(0, 122, 255, 0.3); }
        .pet-slot.legendary { border: 2px solid #ffd700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.6); animation: glow 2s infinite; }
        .pet-slot.locked { background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.2); }
        .pet-silhouette { filter: brightness(0) opacity(0.3); pointer-events: none; }
        .slot-count { position: absolute; bottom: -2px; right: -2px; background: #007aff; color: white; font-size: 9px; padding: 1px 4px; border-radius: 6px; font-weight: bold; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #2c2c2e; width: 90%; max-width: 320px; border-radius: 20px; padding: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h2 { margin: 0; color: #fff; font-size: 20px; }
        .close-btn { background: none; border: none; color: #8e8e93; font-size: 24px; cursor: pointer; padding: 5px; }
        
        .shop-tabs { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; box-sizing: border-box; }
        .tab-btn { flex: 1; background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: bold; min-width: 70px; }
        .tab-btn.active { background: #007aff; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .shop-item { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; border: 2px solid transparent; }
        .shop-item.active { border-color: #34c759; }
        .shop-item-icon { font-size: 30px; margin-bottom: 5px; }
        .shop-item-name { font-size: 14px; margin-bottom: 5px; font-weight: bold; }
        .buy-btn { background: #34c759; border: none; color: #fff; padding: 8px; border-radius: 8px; font-size: 12px; width: 100%; cursor: pointer; font-weight: bold; }
        .buy-btn.locked { background: #3a3a3c; color: #8e8e93; }
        .buy-btn.owned { background: #007aff; }
        
        .achievement-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; display: flex; align-items: center; gap: 10px; text-align: left; border: 1px solid transparent; opacity: 0.8; }
        .achievement-card.unlocked { opacity: 1; border-color: #ffd700; background: rgba(255, 215, 0, 0.1); }
        .ach-icon { font-size: 24px; }
        .ach-info { flex: 1; }
        .ach-title { font-size: 14px; font-weight: bold; margin: 0; }
        .ach-desc { font-size: 12px; color: #8e8e93; margin: 2px 0 0 0; }
        
        .pet-big-icon { font-size: 80px; margin: 10px 0; animation: breathe 3s infinite; }
        .pet-name { font-size: 24px; margin: 5px 0; }
        .pet-rarity { font-size: 14px; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        .pet-rarity.common { color: #8e8e93; }
        .pet-rarity.rare { color: #007aff; }
        .pet-rarity.legendary { color: #ffd700; }
        .pet-price { font-size: 18px; color: #85bb65; margin-bottom: 15px; }
        .sell-action { background-color: #ff3b30; margin-top: 10px; }
        
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); width: 100%; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a3a3c; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 2px; bottom: 2px; background-color: white; transition: .4s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #34c759; }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        
        body.theme-forest { background: linear-gradient(135deg, #134e5e, #71b280); }
        body.theme-space { background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); }
        body.theme-gold { background: linear-gradient(135deg, #3e2b0e, #d4af37); }
        body.theme-neon { background: linear-gradient(135deg, #200122, #6f0000); }
    </style>
</head>
<body>

    <button id="emergency-reset" onclick="hardReset()">üÜò –ê–í–ê–†–ò–ô–ù–´–ô –°–ë–†–û–° (–ù–∞–∂–º–∏ –µ—Å–ª–∏ –∑–∞–≤–∏—Å–ª–æ)</button>
    <div id="debug-console"></div>

    <div id="toast-container"></div>

    <div id="settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header"><h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><button class="close-btn" onclick="closeModal('settings-modal')">‚úñ</button></div>
            <div class="settings-list">
                <div class="setting-item"><span>–í–∏–±—Ä–∞—Ü–∏—è</span><label class="switch"><input type="checkbox" id="vibration-toggle" checked><span class="slider round"></span></label></div>
                <div class="setting-item"><span style="opacity: 0.5;">–ó–≤—É–∫ (–°–∫–æ—Ä–æ)</span><label class="switch"><input type="checkbox" id="sound-toggle" disabled><span class="slider round"></span></label></div>
                <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 0;">
                <button class="btn stop" style="font-size:14px; padding:10px;" onclick="hardReset()">–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å</button>
            </div>
        </div>
    </div>

    <div id="shop-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header"><h2>–ú–∞–≥–∞–∑–∏–Ω</h2><button class="close-btn" onclick="closeModal('shop-modal')">‚úñ</button></div>
            <div class="shop-tabs">
                <button class="tab-btn active" onclick="switchShopTab('themes')">–§–æ–Ω—ã</button>
                <button class="tab-btn" onclick="switchShopTab('eggs')">–Ø–π—Ü–∞</button>
                <button class="tab-btn" onclick="switchShopTab('boosters')">–ë—É—Å—Ç–µ—Ä—ã</button>
            </div>
            <div id="shop-items" class="shop-grid"></div>
        </div>
    </div>

    <div id="achievements-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header"><h2>–ù–∞–≥—Ä–∞–¥—ã</h2><button class="close-btn" onclick="closeModal('achievements-modal')">‚úñ</button></div>
            <div class="shop-tabs">
                <button class="tab-btn active" onclick="switchAchTab('achievements')">–ê—á–∏–≤–∫–∏</button>
                <button class="tab-btn" onclick="switchAchTab('quests')">–ö–≤–µ—Å—Ç—ã</button>
            </div>
            <div id="achievements-list" class="shop-grid" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>
    </div>

    <div id="pet-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header"><h2>–ü–∏—Ç–æ–º–µ—Ü</h2><button class="close-btn" onclick="closeModal('pet-modal')">‚úñ</button></div>
            <div id="pet-detail-view"></div>
        </div>
    </div>

    <div class="container">
        <div class="top-bar">
            <div class="left-buttons">
                <button class="icon-btn" onclick="openShop()">üõçÔ∏è</button>
                <button class="icon-btn" onclick="openAch()">üèÜ<div id="ach-badge" class="red-dot" style="display: none;"></div></button>
            </div>
            <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
        </div>

        <h1>Focus Hatcher</h1>

        <div class="level-container">
            <div class="stats-row"><div class="level-info"><span id="rank-name">–ù–æ–≤–∏—á–æ–∫</span> <span id="level-number">Lvl 1</span></div><div class="money-display" id="total-money">üí∞ 0</div></div>
            <div id="unique-count" style="font-size: 12px; color: #8e8e93; margin-bottom: 5px; text-align: left;">–ö–æ–ª–ª–µ–∫—Ü–∏—è: 0 / 24</div>
            <div class="progress-bar-bg"><div id="xp-bar" class="progress-bar-fill" style="width: 0%;"></div></div>
        </div>
        
        <div class="slider-container">
            <button id="prev-btn" class="arrow-btn" onclick="prevMode()">‚ùÆ</button>
            <div id="egg-wrapper"><div id="egg-display" class="egg">ü•ö</div></div>
            <button id="next-btn" class="arrow-btn" onclick="nextMode()">‚ùØ</button>
        </div>

        <div id="mode-info"><h2 id="mode-title">25 –º–∏–Ω—É—Ç</h2><p id="mode-subtitle">–û–±—ã—á–Ω—ã–π —à–∞–Ω—Å</p></div>
        
        <div id="boosters-panel" class="boosters-container"></div>
        <div id="timer">25:00</div>
        
        <button id="main-btn" class="btn" onclick="toggleTimer()">–ù–∞—á–∞—Ç—å —Ñ–æ–∫—É—Å</button>
        <button id="share-btn" class="btn share-btn" style="display: none;" onclick="handleShare()">–ü–æ—Ö–≤–∞—Å—Ç–∞—Ç—å—Å—è üì¢</button>
        
        <div class="inventory-header" onclick="toggleInventory()"><span>–ú–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è</span><span id="inventory-arrow">‚ñº</span></div>
        <div id="collection" class="hidden"></div>
    </div>

    <script>
        // === –õ–û–í–£–®–ö–ê –û–®–ò–ë–û–ö ===
        const debugConsole = document.getElementById('debug-console');
        window.onerror = function(msg, source, lineno) {
            debugConsole.style.display = 'block';
            debugConsole.innerHTML += `<div class="error-msg">‚ùå –û—à–∏–±–∫–∞: ${msg} (—Å—Ç—Ä. ${lineno})</div>`;
            return false;
        };
        
        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ ===
        const MODES = [
            { id: 'short', time: 10, xpReward: 250, egg: 'ü•ö', title: '25 –º–∏–Ω—É—Ç', sub: '–®–∞–Ω—Å –õ–µ–≥–µ–Ω–¥–∞—Ä–∫–∏: 1%', style: '' },
            { id: 'long', time: 20, xpReward: 1000, egg: 'üíé', title: '60 –º–∏–Ω—É—Ç', sub: '–®–∞–Ω—Å –õ–µ–≥–µ–Ω–¥–∞—Ä–∫–∏: 5% üî•', style: 'hardcore' }
        ];
        const PRICES = { common: 15, rare: 150, legendary: 5000 };
        const RANKS = ["–ù–æ–≤–∏—á–æ–∫", "–ò—Å–∫–∞—Ç–µ–ª—å", "–£–∫—Ä–æ—Ç–∏—Ç–µ–ª—å", "–ú–∞—Å—Ç–µ—Ä", "–ù–∏–Ω–¥–∑—è", "–õ–µ–≥–µ–Ω–¥–∞", "–ë–æ–≥ –§–æ–∫—É—Å–∞"];
        
        // –í–ê–ñ–ù–û: –ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ petDatabase
        const petDatabase = {
            common: ["üê£", "üê±", "üê∂", "üêπ", "üê∞", "üê∏", "üêª", "üê®", "üê§", "üêõ"],
            rare: ["ü¶ä", "üêº", "üêØ", "ü¶Å", "üêÆ", "üê∑", "üêµ", "ü¶â"],
            legendary: ["ü¶Ñ", "üê≤", "üëΩ", "ü§ñ", "ü¶ñ", "üî•"]
        };
        const ALL_PETS_FLAT = [...petDatabase.common, ...petDatabase.rare, ...petDatabase.legendary];
        const TOTAL_PETS_COUNT = ALL_PETS_FLAT.length;
        
        const ACHIEVEMENTS_DATA = [
            { id: 'first_hatch', title: '–ü–µ—Ä–≤—ã–π —à–∞–≥', desc: '–í—ã—Ä–∞—Å—Ç–∏ 1 –ø–∏—Ç–æ–º—Ü–∞', goal: 1, reward: 100 },
            { id: 'rich_kid', title: '–ë–æ–≥–∞—á', desc: '–ó–∞—Ä–∞–±–æ—Ç–∞–π $1000', goal: 1000, type: 'money', reward: 500 },
            { id: 'collector', title: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', desc: '–°–æ–±–µ—Ä–∏ 5 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö', goal: 5, type: 'unique', reward: 1000 },
            { id: 'hard_worker', title: '–¢—Ä—É–¥—è–≥–∞', desc: '–í—ã—Ä–∞—Å—Ç–∏ 10 –ø–∏—Ç–æ–º—Ü–µ–≤', goal: 10, reward: 2000 }
        ];
        const QUESTS_DATA = [
            { id: 'sub_channel', title: '–ü–æ–¥–ø–∏—Å–∫–∞', desc: '–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª', reward: 1000, type: 'link', url: 'https://t.me/focushatch' },
            { id: 'invite_friends', title: '–î—Ä—É–∑—å—è', desc: '–ü—Ä–∏–≥–ª–∞—Å–∏ 5 –¥—Ä—É–∑–µ–π', reward: 2000, type: 'invite', goal: 5 }
        ];
        const SHOP_DATA = {
            themes: [ { id: 'default', name: '–¢—å–º–∞', price: 0, cssClass: '' }, { id: 'forest', name: '–õ–µ—Å', price: 500, cssClass: 'theme-forest' }, { id: 'space', name: '–ö–æ—Å–º–æ—Å', price: 2000, cssClass: 'theme-space' }, { id: 'neon', name: '–ù–µ–æ–Ω', price: 5000, cssClass: 'theme-neon' }, { id: 'gold', name: '–ú–∞–∂–æ—Ä', price: 10000, cssClass: 'theme-gold' } ],
            eggs: [ { id: 'default', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', price: 0, skinClass: '' }, { id: 'glow', name: '–°–∏—è–Ω–∏–µ', price: 1000, skinClass: 'skin-glow' }, { id: 'ice', name: '–õ–µ–¥', price: 3000, skinClass: 'skin-ice' }, { id: 'glitch', name: '–ì–ª—é–∫', price: 7777, skinClass: 'skin-glitch' }, { id: 'gold', name: '–ó–æ–ª–æ—Ç–æ', price: 15000, skinClass: 'skin-gold' } ],
            boosters: [ { id: 'luck', name: '–ó–µ–ª—å–µ –£–¥–∞—á–∏', price: 200, icon: 'üçÄ', desc: '–®–∞–Ω—Å x5' }, { id: 'speed', name: '–£—Å–∫–æ—Ä–∏—Ç–µ–ª—å', price: 500, icon: '‚è≥', desc: '–í—Ä–µ–º—è / 2' } ]
        };
        const botLink = "https://t.me/FocusHatcher_Ondey_bot/game";

        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø ===
        // –û–±—ä—è–≤–ª—è–µ–º –∏—Ö –∑–¥–µ—Å—å, —á—Ç–æ–±—ã initGame –∏—Ö –≤–∏–¥–µ–ª–∞
        let collection = [];
        let userXP = 0;
        let userLevel = 1;
        let walletBalance = 0;
        let ownedItems = { themes: ['default'], eggs: ['default'] };
        let activeTheme = 'default';
        let activeEggSkin = 'default';
        let userStats = { hatched: 0, earned: 0, invites: 0 };
        let myBoosters = { luck: 0, speed: 0 };
        let claimedAchievements = [];
        let claimedQuests = [];
        let isVibrationOn = true;

        let currentModeIndex = 0;
        let timerInterval = null;
        let isRunning = false;
        let timeLeft = MODES[0].time;
        let activeBoosters = { luck: false, speed: false };
        let currentShopTab = 'themes';
        let currentAchTab = 'achievements';
        let selectedPet = null;

        // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
        function getEl(id) { return document.getElementById(id); }
        function closeModal(id) { getEl(id).style.display = 'none'; }
        function openShop() { getEl('shop-modal').style.display = 'flex'; switchShopTab('themes'); }
        function openSettings() { getEl('settings-modal').style.display = 'flex'; }
        function openAch() { getEl('achievements-modal').style.display = 'flex'; switchAchTab('achievements'); }
        function showToast(msg, icon='üîî') {
            const c = getEl('toast-container');
            const d = document.createElement('div');
            d.className = 'toast';
            d.innerHTML = `<span style="font-size:18px">${icon}</span> <span>${msg}</span>`;
            c.appendChild(d);
            setTimeout(() => { d.classList.add('fade-out'); setTimeout(()=>d.remove(), 300); }, 3000);
        }
        function formatTime(s) {
            const m = Math.floor(s / 60).toString().padStart(2, '0');
            const sec = (s % 60).toString().padStart(2, '0');
            return `${m}:${sec}`;
        }
        function getPetRarity(p) {
            if(petDatabase.legendary.includes(p)) return 'legendary';
            if(petDatabase.rare.includes(p)) return 'rare';
            return 'common';
        }
        function hardReset() {
            if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è? –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è.")) {
                localStorage.clear();
                location.reload();
            }
        }

        // === –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–£–°–ö–ê (—Ç–µ–ø–µ—Ä—å –æ–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –∏ –≤–∏–¥–Ω–∞ –≤—Å–µ–º) ===
        function initGame() {
            // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            try {
                collection = JSON.parse(localStorage.getItem('myCollection')) || [];
                userXP = parseInt(localStorage.getItem('userXP')) || 0;
                userLevel = parseInt(localStorage.getItem('userLevel')) || 1;
                walletBalance = parseInt(localStorage.getItem('walletBalance')) || 0;
                ownedItems = JSON.parse(localStorage.getItem('ownedItems')) || { themes: ['default'], eggs: ['default'] };
                activeTheme = localStorage.getItem('activeTheme') || 'default';
                activeEggSkin = localStorage.getItem('activeEggSkin') || 'default';
                
                let s = JSON.parse(localStorage.getItem('userStats'));
                if(s) userStats = s;
                
                let b = JSON.parse(localStorage.getItem('myBoosters'));
                if(b) myBoosters = b;
                
                claimedAchievements = JSON.parse(localStorage.getItem('claimedAchievements')) || [];
                claimedQuests = JSON.parse(localStorage.getItem('claimedQuests')) || [];
                isVibrationOn = localStorage.getItem('isVibrationOn') !== 'false';
            } catch(e) {
                console.error("Data load error", e);
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –±–∏—Ç—ã–µ - –Ω–µ –∫—Ä–∞—à–∏–º—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç
            }

            // –†–µ–Ω–¥–µ—Ä UI
            updateLevelUI();
            renderCollection();
            applyTheme();
            updateUI();
            updateBalanceUI();
            
            // –ï—Å–ª–∏ –≤–∏–±—Ä–∞—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞
            if(getEl('vibration-toggle')) {
                getEl('vibration-toggle').checked = isVibrationOn;
                getEl('vibration-toggle').onchange = (e) => { isVibrationOn = e.target.checked; localStorage.setItem('isVibrationOn', isVibrationOn); };
            }
        }

        // === –õ–û–ì–ò–ö–ê –ò–ì–†–´ ===
        function updateBalanceUI() {
            getEl('total-money').textContent = `üí∞ $${walletBalance}`;
            getEl('unique-count').textContent = `–ö–æ–ª–ª–µ–∫—Ü–∏—è: ${new Set(collection).size} / ${TOTAL_PETS_COUNT}`;
            checkAchievements();
            renderBoostersPanel();
        }

        function checkAchievements() {
            let hasUnclaimed = false;
            let uniqueCount = new Set(collection).size;
            ACHIEVEMENTS_DATA.forEach(a => {
                if(!claimedAchievements.includes(a.id)) {
                    let done = false;
                    if(a.type === 'money' && userStats.earned >= a.goal) done = true;
                    else if(a.type === 'unique' && uniqueCount >= a.goal) done = true;
                    else if(!a.type && userStats.hatched >= a.goal) done = true;
                    if(done) hasUnclaimed = true;
                }
            });
            QUESTS_DATA.forEach(q => {
                if(!claimedQuests.includes(q.id)) {
                    if(q.type === 'invite' && (userStats.invites||0) >= q.goal) hasUnclaimed = true;
                }
            });
            getEl('ach-badge').style.display = hasUnclaimed ? 'block' : 'none';
        }

        function renderBoostersPanel() {
            const p = getEl('boosters-panel');
            p.innerHTML = '';
            let l = myBoosters.luck || 0;
            let s = myBoosters.speed || 0;
            p.appendChild(createBoosterBtn('luck', 'üçÄ', l, activeBoosters.luck));
            p.appendChild(createBoosterBtn('speed', '‚è≥', s, activeBoosters.speed));
        }

        function createBoosterBtn(type, icon, count, isActive) {
            const d = document.createElement('div');
            d.className = `booster-slot ${isActive ? 'active' : ''} ${count===0 ? 'empty' : ''}`;
            d.innerHTML = `${icon} <div class="booster-count">${count}</div>`;
            d.onclick = () => {
                if(count > 0 && !isRunning) {
                    activeBoosters[type] = !activeBoosters[type];
                    renderBoostersPanel();
                    updateUI();
                }
            };
            return d;
        }

        function prevMode() { if(!isRunning) { currentModeIndex = currentModeIndex===0 ? 1 : 0; updateUI(); } }
        function nextMode() { if(!isRunning) { currentModeIndex = currentModeIndex===0 ? 1 : 0; updateUI(); } }
        
        function updateUI() {
            const m = MODES[currentModeIndex];
            let t = m.time;
            if(activeBoosters.speed) t = Math.floor(t / 2);
            if(!isRunning) {
                getEl('egg-display').textContent = m.egg;
                getEl('timer').textContent = formatTime(t);
                applyEggSkin();
            }
            getEl('mode-title').textContent = m.title;
            getEl('mode-subtitle').textContent = m.sub;
        }

        function toggleTimer() {
            if(isRunning) stopTimer(); else startTimer();
        }

        function startTimer() {
            const m = MODES[currentModeIndex];
            timeLeft = activeBoosters.speed ? Math.floor(m.time / 2) : m.time;
            isRunning = true;
            getEl('timer').textContent = formatTime(timeLeft);
            getEl('main-btn').textContent = "–°–¥–∞—Ç—å—Å—è";
            getEl('main-btn').className = "btn stop";
            getEl('share-btn').style.display = 'none';
            getEl('prev-btn').style.visibility = 'hidden';
            getEl('next-btn').style.visibility = 'hidden';
            
            applyEggSkin();
            getEl('egg-display').classList.add('shaking');
            renderBoostersPanel();

            timerInterval = setInterval(() => {
                timeLeft--;
                getEl('timer').textContent = formatTime(timeLeft);
                if(timeLeft <= 0) finishTimer();
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval); isRunning = false;
            getEl('main-btn').textContent = "–ù–∞—á–∞—Ç—å —Ñ–æ–∫—É—Å";
            getEl('main-btn').className = "btn";
            getEl('prev-btn').style.visibility = 'visible';
            getEl('next-btn').style.visibility = 'visible';
            getEl('egg-display').classList.remove('shaking');
            applyEggSkin();
            updateUI();
            renderBoostersPanel();
            showToast("–§–æ–∫—É—Å –ø—Ä–µ—Ä–≤–∞–Ω", "‚ö†Ô∏è");
        }

        function finishTimer() {
            clearInterval(timerInterval); isRunning = false;
            getEl('main-btn').textContent = "–ï—â–µ —Ä–∞–∑";
            getEl('main-btn').className = "btn";
            getEl('share-btn').style.display = 'block';
            getEl('prev-btn').style.visibility = 'visible';
            getEl('next-btn').style.visibility = 'visible';
            getEl('egg-display').className = 'egg';

            const m = MODES[currentModeIndex];
            
            userXP += m.xpReward;
            if(userXP >= userLevel * 200) { userXP -= userLevel * 200; userLevel++; showToast(`Lvl UP: ${userLevel}`, "üéâ"); }
            localStorage.setItem('userXP', userXP);
            localStorage.setItem('userLevel', userLevel);
            updateLevelUI();

            userStats.hatched++;
            localStorage.setItem('userStats', JSON.stringify(userStats));

            let legChance = m.id === 'short' ? 1 : 5;
            let rareChance = m.id === 'short' ? 15 : 30;
            
            if(activeBoosters.luck) { legChance *= 5; myBoosters.luck--; activeBoosters.luck = false; }
            if(activeBoosters.speed) { myBoosters.speed--; activeBoosters.speed = false; }
            localStorage.setItem('myBoosters', JSON.stringify(myBoosters));
            renderBoostersPanel();

            const rnd = Math.random() * 100;
            let pool;
            if(rnd < legChance) pool = petDatabase.legendary;
            else if(rnd < legChance + rareChance) pool = petDatabase.rare;
            else pool = petDatabase.common;

            const dropped = pool[Math.floor(Math.random() * pool.length)];
            collection.push(dropped);
            localStorage.setItem('myCollection', JSON.stringify(collection));
            
            getEl('egg-display').textContent = dropped;
            showToast(`–ü–æ–ª—É—á–µ–Ω–æ: ${dropped}`, "üê£");
            
            renderCollection();
            updateBalanceUI();
            
            const colDiv = getEl('collection');
            if(colDiv.classList.contains('hidden')) {
                colDiv.classList.remove('hidden');
                getEl('inventory-arrow').textContent = "‚ñ≤";
            }
            
            if(isVibrationOn && window.navigator.vibrate) window.navigator.vibrate(200);
        }

        function toggleInventory() {
            const c = getEl('collection');
            const a = getEl('inventory-arrow');
            if(c.classList.contains('hidden')) { c.classList.remove('hidden'); a.textContent="‚ñ≤"; }
            else { c.classList.add('hidden'); a.textContent="‚ñº"; }
        }

        function renderCollection() {
            const c = getEl('collection');
            c.innerHTML = '';
            ALL_PETS_FLAT.forEach(pet => {
                const count = collection.filter(p => p === pet).length;
                const rarity = getPetRarity(pet);
                const d = document.createElement('div');
                if(count > 0) {
                    d.className = `pet-slot ${rarity}`;
                    d.textContent = pet;
                    if(count > 1) { const b = document.createElement('div'); b.className='slot-count'; b.textContent = `x${count}`; d.appendChild(b); }
                    d.onclick = () => openPetModal(pet, true);
                } else {
                    d.className = `pet-slot locked`;
                    d.innerHTML = `<span class="pet-silhouette">${pet}</span>`;
                    d.onclick = () => openPetModal(pet, false);
                }
                c.appendChild(d);
            });
        }

        function openPetModal(pet, owned) {
            selectedPet = pet;
            const r = getPetRarity(pet);
            const price = PRICES[r];
            const modal = getEl('pet-modal');
            const view = getEl('pet-detail-view');
            modal.style.display = 'flex';
            if(owned) {
                view.innerHTML = `<div class="pet-big-icon">${pet}</div><h3 class="pet-name">–ü–∏—Ç–æ–º–µ—Ü</h3><p class="pet-rarity ${r}">${r}</p><p class="pet-price">–¶–µ–Ω–∞: $${price}</p><button class="btn sell-action" onclick="sellPet()">–ü—Ä–æ–¥–∞—Ç—å ($${price})</button>`;
            } else {
                view.innerHTML = `<div class="pet-big-icon" style="filter:brightness(0) opacity(0.3)">${pet}</div><h3 class="pet-name">???</h3><p class="pet-rarity ${r}">${r}</p><button class="btn" style="background:#333" onclick="closeModal('pet-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>`;
            }
        }

        function sellPet() {
            if(!selectedPet) return;
            const idx = collection.indexOf(selectedPet);
            if(idx === -1) return;
            const price = PRICES[getPetRarity(selectedPet)];
            walletBalance += price;
            userStats.earned += price;
            localStorage.setItem('walletBalance', walletBalance);
            localStorage.setItem('userStats', JSON.stringify(userStats));
            collection.splice(idx, 1);
            localStorage.setItem('myCollection', JSON.stringify(collection));
            updateBalanceUI();
            renderCollection();
            closeModal('pet-modal');
            showToast(`–ü—Ä–æ–¥–∞–Ω–æ +$${price}`, "üí∞");
        }

        function switchShopTab(tab) {
            currentShopTab = tab;
            document.querySelectorAll('#shop-modal .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderShop();
        }

        function renderShop() {
            const c = getEl('shop-items');
            c.innerHTML = '';
            SHOP_DATA[currentShopTab].forEach(item => {
                const d = document.createElement('div');
                d.className = 'shop-item';
                let btnHTML = '';
                if(currentShopTab === 'boosters') {
                    btnHTML = `<button class="buy-btn" onclick="buyItem('${item.id}', ${item.price})">$${item.price}</button>`;
                    d.innerHTML = `<div class="shop-item-icon">${item.icon}</div><div class="shop-item-name">${item.name}</div><div style="font-size:10px;color:#888">${item.desc}</div>${btnHTML}`;
                } else {
                    const owned = ownedItems[currentShopTab].includes(item.id);
                    const active = (currentShopTab==='themes' && activeTheme===item.id) || (currentShopTab==='eggs' && activeEggSkin===item.id);
                    let cls = owned ? "buy-btn owned" : "buy-btn";
                    if(!owned && walletBalance < item.price) cls += " locked";
                    let txt = owned ? (active?"–í—ã–±—Ä–∞–Ω–æ":"–í—ã–±—Ä–∞—Ç—å") : `$${item.price}`;
                    btnHTML = `<button class="${cls}" onclick="buyItem('${item.id}', ${item.price})">${txt}</button>`;
                    d.innerHTML = `<div class="shop-item-icon">${currentShopTab==='themes'?'üé®':'ü•ö'}</div><div class="shop-item-name">${item.name}</div>${btnHTML}`;
                }
                c.appendChild(d);
            });
        }

        function buyItem(id, price) {
            if(currentShopTab === 'boosters') {
                if(walletBalance >= price) {
                    walletBalance -= price;
                    if(!myBoosters[id]) myBoosters[id] = 0;
                    myBoosters[id]++;
                    saveData();
                    updateBalanceUI();
                    showToast("–ö—É–ø–ª–µ–Ω–æ!", "üß™");
                } else showToast("–ú–∞–ª–æ –¥–µ–Ω–µ–≥", "üö´");
                return;
            }
            const owned = ownedItems[currentShopTab].includes(id);
            if(owned) {
                if(currentShopTab === 'themes') { activeTheme = id; applyTheme(); }
                else { activeEggSkin = id; applyEggSkin(); }
                saveData(); renderShop();
            } else {
                if(walletBalance >= price) {
                    walletBalance -= price;
                    ownedItems[currentShopTab].push(id);
                    if(currentShopTab === 'themes') { activeTheme = id; applyTheme(); }
                    else { activeEggSkin = id; applyEggSkin(); }
                    saveData(); updateBalanceUI(); renderShop(); showToast("–ö—É–ø–ª–µ–Ω–æ!", "üõçÔ∏è");
                } else showToast("–ú–∞–ª–æ –¥–µ–Ω–µ–≥", "üö´");
            }
        }

        function switchAchTab(tab) {
            currentAchTab = tab;
            document.querySelectorAll('#achievements-modal .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if(tab === 'achievements') renderAch(); else renderQuests();
        }

        function renderAch() {
            const c = getEl('achievements-list'); c.innerHTML = '';
            let u = new Set(collection).size;
            ACHIEVEMENTS_DATA.forEach(a => {
                const claimed = claimedAchievements.includes(a.id);
                let done = false;
                if(a.type === 'money' && userStats.earned >= a.goal) done = true;
                else if(a.type === 'unique' && u >= a.goal) done = true;
                else if(!a.type && userStats.hatched >= a.goal) done = true;
                
                const d = document.createElement('div');
                d.className = `achievement-card ${done ? 'unlocked' : ''}`;
                let btn = '';
                if(done && !claimed) btn = `<button class="buy-btn" onclick="claimAch('${a.id}', ${a.reward})">–ó–∞–±—Ä–∞—Ç—å $${a.reward}</button>`;
                else if(claimed) btn = "‚úÖ";
                else btn = `<span style="font-size:12px;color:#888">–¶–µ–ª—å: ${a.goal}</span>`;
                d.innerHTML = `<div class="ach-icon">${done?'üèÜ':'üîí'}</div><div class="ach-info"><div class="ach-title">${a.title}</div><div class="ach-desc">${a.desc}</div></div><div>${btn}</div>`;
                c.appendChild(d);
            });
        }

        function renderQuests() {
            const c = getEl('achievements-list'); c.innerHTML = '';
            QUESTS_DATA.forEach(q => {
                const claimed = claimedQuests.includes(q.id);
                const d = document.createElement('div');
                d.className = `achievement-card ${claimed ? 'unlocked' : ''}`;
                let btn = '';
                if(claimed) btn = "‚úÖ";
                else if(q.type === 'link') btn = `<button id="qbtn-${q.id}" class="buy-btn" style="background:#007aff" onclick="clickLink('${q.id}', '${q.url}', ${q.reward})">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>`;
                else if(q.type === 'invite') {
                    if((userStats.invites||0) >= q.goal) btn = `<button class="buy-btn" onclick="claimQuest('${q.id}', ${q.reward})">–ó–∞–±—Ä–∞—Ç—å $${q.reward}</button>`;
                    else btn = `<span style="font-size:12px;color:#888">${userStats.invites||0}/${q.goal}</span>`;
                }
                d.innerHTML = `<div class="ach-icon">üìú</div><div class="ach-info"><div class="ach-title">${q.title}</div><div class="ach-desc">${q.desc}</div></div><div>${btn}</div>`;
                c.appendChild(d);
            });
        }

        function clickLink(id, url, reward) {
            if(window.Telegram.WebApp) window.Telegram.WebApp.openLink(url); else window.open(url, '_blank');
            const b = getEl(`qbtn-${id}`);
            if(b) { b.textContent = "–ü—Ä–æ–≤–µ—Ä—è—é..."; b.disabled = true; b.style.background = "#555"; setTimeout(() => claimQuest(id, reward), 4000); }
        }

        function claimAch(id, reward) {
            if(claimedAchievements.includes(id)) return;
            claimedAchievements.push(id); walletBalance += reward;
            saveData(); updateBalanceUI(); renderAch(); showToast(`–ù–∞–≥—Ä–∞–¥–∞ +$${reward}`);
        }

        function claimQuest(id, reward) {
            if(claimedQuests.includes(id)) return;
            claimedQuests.push(id); walletBalance += reward;
            saveData(); updateBalanceUI(); renderQuests(); showToast(`–ù–∞–≥—Ä–∞–¥–∞ +$${reward}`);
        }

        function handleShare() {
            if(!userStats.invites) userStats.invites = 0; 
            userStats.invites++; 
            saveData(); 
            checkAchievements();
            const text = `–£ –º–µ–Ω—è ${new Set(collection).size} –ø–µ—Ç–æ–≤ –≤ Focus Hatcher!`;
            const url = `https://t.me/share/url?url=${botLink}&text=${encodeURIComponent(text)}`;
            if (window.Telegram.WebApp) window.Telegram.WebApp.openTelegramLink(url); else window.open(url, '_blank');
        }

        function saveData() {
            localStorage.setItem('walletBalance', walletBalance);
            localStorage.setItem('ownedItems', JSON.stringify(ownedItems));
            localStorage.setItem('activeTheme', activeTheme);
            localStorage.setItem('activeEggSkin', activeEggSkin);
            localStorage.setItem('userStats', JSON.stringify(userStats));
            localStorage.setItem('myBoosters', JSON.stringify(myBoosters));
            localStorage.setItem('claimedAchievements', JSON.stringify(claimedAchievements));
            localStorage.setItem('claimedQuests', JSON.stringify(claimedQuests));
        }

        function applyTheme() { const t = SHOP_DATA.themes.find(x => x.id === activeTheme); document.body.className = t ? t.cssClass : ''; }
        
        function applyEggSkin() { 
            const s = SHOP_DATA.eggs.find(x => x.id === activeEggSkin); 
            const egg = getEl('egg-display');
            egg.className = 'egg'; 
            if(MODES[currentModeIndex].style === 'hardcore') egg.classList.add('diamond-egg'); 
            else if(s && s.skinClass && activeEggSkin !== 'default') egg.classList.add(s.skinClass); 
            if(isRunning) egg.classList.add('shaking'); 
        }

        function updateLevelUI() {
            const max = userLevel * 200;
            let p = (userXP / max) * 100;
            if(p > 100) p = 100;
            getEl('xp-bar').style.width = `${p}%`;
            getEl('level-number').textContent = `Lvl ${userLevel}`;
            let r = Math.floor(userLevel / 5);
            getEl('rank-name').textContent = RANKS[Math.min(r, RANKS.length-1)];
        }

        // –ó–ê–ü–£–°–ö
        window.onload = initGame;

    </script>
</body>
</html>